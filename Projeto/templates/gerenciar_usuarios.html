{% extends "base.html" %}

{% block title %}Gerenciar Moradores{% endblock %}

{% block page_title %}Gerenciar Usuários{% endblock %}

{% block content %}
    <style>
        /* Estilos específicos para a página de usuários */
        .subtitle{
            color:var(--muted); margin:4px 0 0; font-size:14px;
        }
        .badge-count{
            background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
            padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px;
        }
        .toolbar{
            display:flex; gap:12px; align-items:center; margin: 18px 0 14px;
            flex-wrap:wrap;
        }
        .search{
            flex:1 1 280px; position:relative;
        }
        .search input{
            width:100%; padding:12px 14px 12px 40px; border:1px solid var(--line);
            border-radius:10px; background:var(--card); outline:none;
            box-shadow:var(--shadow);
        }
        .search-icon{
            position:absolute; left:12px; top:50%; transform:translateY(-50%);
            font-size:16px; color:var(--muted);
        }
        .btn{
            padding:10px 14px; border-radius:10px; border:1px solid var(--line);
            background:var(--card); cursor:pointer; font-weight:600;
            transition:.15s transform ease, .15s filter ease; box-shadow:var(--shadow);
            text-decoration: none;
            color: var(--text);
            text-align: center;
        }
        .btn:hover{ transform:translateY(-1px); filter:brightness(0.98); }
        
        .btn-success{ 
            background:var(--success); 
            color:#fff; 
            border:none; 
        }
        .btn-success:hover {
            background-color: #15803d;
        }

        .btn-danger{ 
            background:var(--danger); 
            color:#fff; 
            border:none; 
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-ghost{ 
            background:#fff; 
            color:var(--text);
        }
        .btn-ghost:hover {
            background-color: #f5f5f5;
        }
        
        .card{
            background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
            box-shadow:var(--shadow); padding:18px; margin-bottom:14px;
        }

        /* ====== Tabela de Usuários ====== */
        .table-wrap{
            overflow:auto; border-radius:12px; border:1px solid var(--line);
            background:var(--card); box-shadow:var(--shadow);
        }
        table{ width:100%; border-collapse:collapse; min-width:720px; }
        thead th{
            text-align:left; font-size:12px; letter-spacing:.02em; text-transform:uppercase;
            color:var(--muted); background:#fafafa; border-bottom:1px solid var(--line); padding:12px;
            position:sticky; top:0; z-index:1;
        }
        tbody td{ padding:14px 12px; border-bottom:1px solid var(--line); vertical-align:middle; }
        tbody tr:hover{ background:#fafafa; }

        .user-cell{ display:flex; align-items:center; gap:12px; }
        .avatar{
            width:36px; height:36px; border-radius:50%; display:inline-grid; place-items:center;
            background:#eef2ff; color:#3730a3; font-weight:700; border:1px solid #c7d2fe;
        }
        .user-meta small{ color:var(--muted); font-size:12px; display:block; }

        .actions{ display:flex; gap:8px; flex-wrap:wrap; }
        .actions form { margin: 0; }
        .status-badge {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-ativo { background: #dcfce7; color: #15803d; }
        .status-desativado { background: #fee2e2; color: #b91c1c; }
        .status-pendente { background: #fef9c3; color: #854d0e; }


        /* ====== Estado Vazio e Voltar ====== */
        .empty{
            text-align:center; color:var(--muted); padding:40px 16px;
        }
        .back{
            display:inline-flex; align-items:center; gap:8px; margin-top:18px; text-decoration:none;
            color:var(--primary); font-weight:600;
        }
        .back:hover{ text-decoration:underline; }

        /* ====== Responsivo ====== */
        @media (max-width: 700px){
            .title-wrap{ flex-direction:column; align-items:flex-start; gap:6px; }
            .toolbar{ gap:10px; }
            .btn{ width:100%; }
            .btn-primary{ order:2; }
            .search{ order:1; }
        }
    </style>
    

    <div class="card">
        <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:space-between;">
            <div>
                <strong>Gerenciar acessos</strong>
                <p class="subtitle">Ative, desative ou exclua usuários cadastrados em seu condomínio.</p>
            </div>
            <div class="toolbar">
                <div class="search">
                    <span class="search-icon">🔎</span>
                    <input id="busca" type="text" placeholder="Buscar por nome ou e-mail..." aria-label="Buscar por nome ou e-mail">
                </div>
                <form method="get" action="{{ url_for('gerenciar_usuarios') }}">
                    <button class="btn btn-ghost" type="submit" title="Recarregar">Recarregar</button>
                </form>
            </div>
        </div>
    </div>

    {% if usuarios %}
        <div class="table-wrap">
            <table id="tabela-usuarios">
                <thead>
                    <tr>
                        <th>Morador</th>
                        <th>E-mail</th>
                        <th>Status</th>
                        <th style="width:240px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in usuarios %}
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">
                                        {% set partes = u.nome.split() %}
                                        {% set inicial1 = partes[0][0] if partes and partes[0] else '' %}
                                        {% set inicial2 = (partes[-1][0] if partes|length > 1 else '') %}
                                        {{ (inicial1 ~ inicial2).upper() }}
                                    </div>
                                    <div class="user-meta">
                                        <div style="font-weight:600">{{ u.nome }}</div>
                                        <small>ID #{{ u.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ u.email }}</td>
                            <td>
                                {% if u.tipo == 1 %}
                                    <span class="status-badge status-pendente">Pendente</span>
                                {% elif u.tipo == 3 %}
                                    <span class="status-badge status-desativado">Desativado</span>
                                {% else %}
                                    <span class="status-badge status-ativo">Ativo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="actions">
                                    {% if u.id != current_user.id %}
                                        {% if u.is_ativo and u.tipo != 1 %}
                                            <form action="{{ url_for('gerenciar_usuarios') }}" method="post">
                                                <input type="hidden" name="usuario_id" value="{{ u.id }}">
                                                <input type="hidden" name="acao" value="desativar">
                                                <button type="submit" class="btn btn-danger">Desativar</button>
                                            </form>
                                        {% elif u.tipo == 1 %}
                                            <form action="{{ url_for('gerenciar_usuarios') }}" method="post">
                                                <input type="hidden" name="usuario_id" value="{{ u.id }}">
                                                <input type="hidden" name="acao" value="ativar">
                                                <button type="submit" class="btn btn-success">Aprovar</button>
                                            </form>
                                        {% elif u.tipo == 3 %}
                                            <form action="{{ url_for('gerenciar_usuarios') }}" method="post">
                                                <input type="hidden" name="usuario_id" value="{{ u.id }}">
                                                <input type="hidden" name="acao" value="ativar">
                                                <button type="submit" class="btn btn-success">Ativar</button>
                                            </form>
                                        {% endif %}
                                        <form action="{{ url_for('excluir_usuario', usuario_id=u.id) }}" method="post" onsubmit="return confirm('Tem certeza que deseja EXCLUIR este usuário? Esta ação não pode ser desfeita.');">
                                            <button type="submit" class="btn btn-danger">Excluir</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="card empty">
            <div style="font-size:18px; font-weight:700; margin-bottom:6px;">Nenhum usuário cadastrado.</div>
            <div>Não há moradores para gerenciar no momento.</div>
        </div>
    {% endif %}

    <p>
        <a class="back" href="{{ url_for('dashboard') }}">← Voltar ao dashboard</a>
    </p>

    <script>
        // Filtro simples por nome/email (cliente)
        (function(){
            const input = document.getElementById('busca');
            const table = document.getElementById('tabela-usuarios');
            if(!input || !table) return;

            input.addEventListener('input', function(){
                const q = this.value.trim().toLowerCase();
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const nome = (row.querySelector('.user-meta div')?.textContent || '').toLowerCase();
                    const email = (row.querySelector('td:nth-child(2)')?.textContent || '').toLowerCase();
                    const match = nome.includes(q) || email.includes(q);
                    row.style.display = match ? '' : 'none';
                });
            });
        })();
    </script>
{% endblock %}