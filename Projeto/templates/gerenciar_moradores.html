{% extends "base.html" %}

{% block title %}Gerenciar Moradores Pendentes{% endblock %}


{% block content %}
    <style>
        /* Estilos espec√≠ficos para a p√°gina de usu√°rios */
        .subtitle{
            color:var(--muted); margin:4px 0 0; font-size:14px;
        }
        .badge-count{
            background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
            padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px;
        }

        /* ====== Toolbar e Card ====== */
        .toolbar{
            display:flex; gap:12px; align-items:center; margin: 18px 0 14px;
            flex-wrap:wrap;
        }
        .search{
            flex:1 1 280px; position:relative;
        }
        .search input{
            width:100%; padding:12px 14px 12px 40px; border:1px solid var(--line);
            border-radius:10px; background:var(--card); outline:none;
            box-shadow:var(--shadow);
        }
        .search-icon{
            position:absolute; left:12px; top:50%; transform:translateY(-50%);
            font-size:16px; color:var(--muted);
        }
        .btn{
            padding:10px 14px; border-radius:10px; border:1px solid var(--line);
            background:var(--card); cursor:pointer; font-weight:600;
            transition:.15s transform ease, .15s filter ease; box-shadow:var(--shadow);
            text-decoration: none;
            color: var(--text);
            text-align: center;
        }
        .btn:hover{ transform:translateY(-1px); filter:brightness(0.98); }
        .btn-success{ background:var(--success); color:#fff; border:none; }
        .btn-danger{ background:var(--danger); color:#fff; border:none; }
        .btn-ghost{ background:#fff; }

        .card{
            background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
            box-shadow:var(--shadow); padding:18px; margin-bottom:14px;
        }

        /* ====== Tabela de Usu√°rios ====== */
        .table-wrap{
            overflow:auto; border-radius:12px; border:1px solid var(--line);
            background:var(--card); box-shadow:var(--shadow);
        }
        table{ width:100%; border-collapse:collapse; min-width:720px; }
        thead th{
            text-align:left; font-size:12px; letter-spacing:.02em; text-transform:uppercase;
            color:var(--muted); background:#fafafa; border-bottom:1px solid var(--line); padding:12px;
            position:sticky; top:0; z-index:1;
        }
        tbody td{ padding:14px 12px; border-bottom:1px solid var(--line); vertical-align:middle; }
        tbody tr:hover{ background:#fafafa; }

        .user-cell{ display:flex; align-items:center; gap:12px; }
        .avatar{
            width:36px; height:36px; border-radius:50%; display:inline-grid; place-items:center;
            background:#eef2ff; color:#3730a3; font-weight:700; border:1px solid #c7d2fe;
        }
        .user-meta small{ color:var(--muted); font-size:12px; display:block; }

        .actions{ display:flex; gap:8px; flex-wrap:wrap; }
        .actions form { margin: 0; }
        .status-badge {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-ativo { background: #dcfce7; color: #15803d; }
        .status-desativado { background: #fee2e2; color: #b91c1c; }
        .status-pendente { background: #fef9c3; color: #854d0e; }


        /* ====== Estado Vazio e Voltar ====== */
        .empty{
            text-align:center; color:var(--muted); padding:40px 16px;
        }
        .back{
            display:inline-flex; align-items:center; gap:8px; margin-top:18px; text-decoration:none;
            color:var(--primary); font-weight:600;
        }
        .back:hover{ text-decoration:underline; }

        /* ====== Responsivo ====== */
        @media (max-width: 700px){
            .title-wrap{ flex-direction:column; align-items:flex-start; gap:6px; }
            .toolbar{ gap:10px; }
            .btn{ width:100%; }
            .btn-primary{ order:2; }
            .search{ order:1; }
        }
    </style>

    <div class="header">
        <div class="title-wrap">
            <h1 class="title">Gerenciar Moradores Pendentes</h1>
            <span class="badge-count">
                {% if pendentes %} {{ pendentes|length }} pendente(s) {% else %} 0 pendentes {% endif %}
            </span>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card">
        <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:space-between;">
            <div>
                <strong>Aprova√ß√£o necess√°ria</strong>
                <p class="subtitle">Usu√°rios rec√©m-cadastrados ficam pendentes at√© o s√≠ndico aprovar.</p>
            </div>
            <div class="toolbar">
                <div class="search">
                    <span class="search-icon">üîé</span>
                    <input id="busca" type="text" placeholder="Buscar por nome ou e-mail..." aria-label="Buscar por nome ou e-mail">
                </div>
                <form method="get" action="{{ url_for('moradores_pendentes') }}">
                    <button class="btn btn-ghost" type="submit" title="Recarregar">Recarregar</button>
                </form>
            </div>
        </div>
    </div>

    {% if pendentes and pendentes|length > 0 %}
        <div class="table-wrap">
            <table id="tabela-pendentes" class="tabela-pendentes">
                <thead>
                    <tr>
                        <th>Morador</th>
                        <th>E-mail</th>
                        <th style="width:240px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pendentes %}
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">
                                        {# iniciais: primeira letra do nome e do √∫ltimo sobrenome, quando existir #}
                                        {% set partes = p.nome.split() %}
                                        {% set inicial1 = partes[0][0] if partes and partes[0] else '' %}
                                        {% set inicial2 = (partes[-1][0] if partes|length > 1 else '') %}
                                        {{ (inicial1 ~ inicial2).upper() }}
                                    </div>
                                    <div class="user-meta">
                                        <div style="font-weight:600">{{ p.nome }}</div>
                                        <small>ID #{{ p.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ p.email }}</td>
                            <td>
                                <div class="actions">
                                    <form action="{{ url_for('aprovar_morador', usuario_id=p.id) }}" method="post">
                                        <button type="submit" class="btn btn-success">Aprovar</button>
                                    </form>
                                    <form action="{{ url_for('negar_morador', usuario_id=p.id) }}" method="post"
                                          onsubmit="return confirm('Tem certeza que deseja negar este cadastro?');">
                                        <button type="submit" class="btn btn-danger">Negar</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="card empty">
            <div style="font-size:18px; font-weight:700; margin-bottom:6px;">Tudo certo por aqui</div>
            <div>N√£o h√° cadastros pendentes no momento.</div>
        </div>
    {% endif %}

    <p>
        <a class="back" href="{{ url_for('dashboard') }}">‚Üê Voltar ao dashboard</a>
    </p>

    <script>
        // Filtro simples por nome/email (cliente)
        (function(){
          const input = document.getElementById('busca');
          const table = document.getElementById('tabela-pendentes');
          if(!input || !table) return;

          input.addEventListener('input', function(){
            const q = this.value.trim().toLowerCase();
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const nome = (row.querySelector('.user-meta div')?.textContent || '').toLowerCase();
              const email = (row.querySelector('td:nth-child(2)')?.textContent || '').toLowerCase();
              const match = nome.includes(q) || email.includes(q);
              row.style.display = match ? '' : 'none';
            });
          });
        })();
    </script>
{% endblock %}