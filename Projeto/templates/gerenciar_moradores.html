{% extends "base.html" %}

{% block title %}Gerenciar Moradores Pendentes{% endblock %}

{% block page_title %}Gerenciar Moradores Pendentes{% endblock %}

{% block content %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="card">
        <div style="display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:space-between;">
            <div>
                <strong>Aprova√ß√£o necess√°ria</strong>
                <p class="subtitle">Usu√°rios rec√©m-cadastrados ficam pendentes at√© o s√≠ndico aprovar.</p>
            </div>
            <div class="toolbar">
                <div class="search">
                    <span class="search-icon">üîé</span>
                    <input id="busca" type="text" placeholder="Buscar por nome ou e-mail..." aria-label="Buscar por nome ou e-mail">
                </div>
                <form method="get" action="{{ url_for('moradores_pendentes') }}">
                    <button class="btn btn-ghost" type="submit" title="Recarregar">Recarregar</button>
                </form>
            </div>
        </div>
    </div>

    {% if pendentes and pendentes|length > 0 %}
        <div class="table-wrap">
            <table id="tabela-pendentes" class="tabela-pendentes">
                <thead>
                    <tr>
                        <th>Morador</th>
                        <th>E-mail</th>
                        <th style="width:240px;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in pendentes %}
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="avatar">
                                        {# iniciais: primeira letra do nome e do √∫ltimo sobrenome, quando existir #}
                                        {% set partes = p.nome.split() %}
                                        {% set inicial1 = partes[0][0] if partes and partes[0] else '' %}
                                        {% set inicial2 = (partes[-1][0] if partes|length > 1 else '') %}
                                        {{ (inicial1 ~ inicial2).upper() }}
                                    </div>
                                    <div class="user-meta">
                                        <div style="font-weight:600">{{ p.nome }}</div>
                                        <small>ID #{{ p.id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ p.email }}</td>
                            <td>
                                <div class="actions">
                                    <form action="{{ url_for('aprovar_morador', usuario_id=p.id) }}" method="post">
                                        <button type="submit" class="btn btn-success">Aprovar</button>
                                    </form>
                                    <form action="{{ url_for('negar_morador', usuario_id=p.id) }}" method="post"
                                          onsubmit="return confirm('Tem certeza que deseja negar este cadastro?');">
                                        <button type="submit" class="btn btn-danger">Negar</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="card empty">
            <div style="font-size:18px; font-weight:700; margin-bottom:6px;">Tudo certo por aqui</div>
            <div>N√£o h√° cadastros pendentes no momento.</div>
        </div>
    {% endif %}
    
    <script>
        // Filtro simples por nome/email (cliente)
        (function(){
          const input = document.getElementById('busca');
          const table = document.getElementById('tabela-pendentes');
          if(!input || !table) return;

          input.addEventListener('input', function(){
            const q = this.value.trim().toLowerCase();
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const nome = (row.querySelector('.user-meta div')?.textContent || '').toLowerCase();
              const email = (row.querySelector('td:nth-child(2)')?.textContent || '').toLowerCase();
              const match = nome.includes(q) || email.includes(q);
              row.style.display = match ? '' : 'none';
            });
          });
        })();
    </script>
{% endblock %}